name: Tests
run-name: Keep track of state changes in tx queue
  
on:
  pull_request:
    branches:
      - master
      
jobs:
  e2e-tests:
    runs-on: [self-hosted, linux, x64, builder]
    steps:
    - name: Checkout pull request head commit
      uses: actions/checkout@v3

    - name: Populate environment
      env:
        SYSTEM_NAME: linux1
      continue-on-error: true
      run: ./make.sh

    - name: Install dependencies
      run: echo "./make.sh ci-setup-deps"
    
    - name: Install dependencies for target
      run: echo "./make.sh ci-setup-deps-target"

    - name: Build deps and configure
      run: echo "./make.sh build"
      
    - name: E2E tests
      run: echo "./make.sh test"

  rust-tests:
    runs-on: [self-hosted, linux, x64]
    needs: e2e-tests
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Populate environment
      env:
        SYSTEM_NAME: linux2
      continue-on-error: true
      run: ./make.sh

    - name: Setup dependencies
      run: echo "./make.sh ci-setup-deps"

    - name: Setup dependencies for target
      run: echo "./make.sh ci-setup-deps-target"

    - name: Build deps and configure
      run: echo "./make.sh build-deps && ./make.sh build-conf"
      
    - name: Rust tests
      run: echo "./make.sh lib test"
